{% comment %}
  Renders facets (filtering and sorting)
  Accepts:
  - results: {Object} Collection or Search object
  - enable_filtering: {Boolean} Show filtering when true
  - enable_sorting: {Boolean} Show sorting when true
  - collapse_on_larger_devices: {Boolean} Collapse filtering/sorting into menu on larger devices when true
  Usage:
  {% render 'facets', results: collection, enable_filtering: true, enable_sorting: true, collapse_on_larger_devices: false %}
{% endcomment %}

{%- liquid
  assign sort_by = results.sort_by | default: 'created-descending'
  if results.url
    assign results_url = results.url
  else
    assign terms = results.terms | escape
    assign results_url = '?q=' | append: terms | append: '&options%5Bprefix%5D=last&sort_by=' | append: sort_by
  endif
-%}

{%- if enable_filtering -%}
  <FacetFiltersFormMobile class="" data-colleciton="{{ collection.handle }}">
    <div class=" facet-drawer" id="Facet-Drawer">
      <div class="side-panel-inner">
        <div class="side-panel-header">
          <div>
            <h4 class="body-font">
              {{ 'products.facets.filter_and_sort' | t }}
              {% comment %}
                <span class="thb-filter-count mobile-filter-count body-font">
                	<span class="facets__label">
                		{%- if results.results_count -%}
                           {{ 'search.results_with_count' | t: terms: results.terms, count: results.results_count }}
                         {%- elsif results.products_count == results.all_products_count -%}
                			{{ 'products.facets.product_count_simple' | t: count: results.products_count }}
                		{%- else -%}
                			{{ 'products.facets.product_count' | t: product_count: results.products_count, count: results.all_products_count }}
                		{%- endif -%}
                	</span>
                	<span class="loading-overlay">
                      {% render 'svg-icons' with 'thb-loading' %}
                    </span>
                </span>
              {% endcomment %}
            </h4>
            <side-panel-close class="side-panel-close">{%- render 'svg-icons' with 'close' -%}</side-panel-close>
          </div>
        </div>

        <div class="side-panel-content">
          <facet-filters-form class="facets">
            <form id="FacetFiltersFormMobile" class="facets__mobile_form">
              <div style="display:none !important" id="temp_facet_filter">
                {%- assign sort_by = results.sort_by | default: results.default_sort_by -%}
                {%- for option in results.sort_options -%}
                  {% if option.value contains 'created-descending'
                    or option.value contains 'best-selling'
                    or option.value contains 'price-ascending'
                    or option.value contains 'price-descending'
                  %}
                    <div class="sort-option">
                      <input
                        type="radio"
                        name="sort_by"
                        value="{{ option.value | escape }}"
                        id="sort_{{ option.value }}"
                        {% if option.value == sort_by %}
                          checked="checked"
                        {% endif %}
                      >
                      <label for="sort_{{ option.value }}">{{ option.name | escape }}</label>
                    </div>
                  {% endif %}
                {%- endfor -%}
              </div>
              {%- if results.terms -%}
                <input type="hidden" name="q" value="{{ results.terms | escape }}">
                <input name="options[prefix]" type="hidden" value="last">
              {%- endif -%}
              {% if results.current_vendor or results.current_type %}
                <input type="hidden" name="q" value="{{ results.current_vendor }}{{ results.current_type }}">
              {% endif %}
              {%- for filter in results.filters -%}
                {% case filter.type %}
                  {% when 'boolean', 'list' %}
                    {%- assign label = filter.label | downcase | replace: ' ', '-' | escape -%}
                    {% if label == 'size' and collection.handle == 'accessories' %}
                      {% continue %}
                    {% endif %}
                    <collapsible-card
                      data-type="{{ filter.label | escape }}"
                      data-index="{{ forloop.index }}"
                      data-slab="{{ label }}"
                      {% if label == 'size' %}
                        data-issizeactive="false"
                      {% endif %}
                    >
                      <details class="thb-filter js-filter" data-index="{{ forloop.index }}" open>
                        <summary class="thb-filter-title">
                          {% comment %}
                            <span></span>
                          {% endcomment %}
                          <span class="label-filter"> {{ filter.label | escape }} </span>
                        </summary>
                        {% if label == 'size' and collection.handle != 'kids' %}
                          <div class="dropdown-toggle-box">
                            <div class="drop-inline-label">
                              <span class="select-arrow-box">{% render 'svg-icons' with 'thb-dropdown-bottom' %}</span
                              ><span id="currentSizeOption">FR</span>
                            </div>
                          </div>
                          <div class="dropdown-menu-box">
                            <div class="dropdown-toggleInline">
                              <button class="country-btn active" data-country="FR">FR</button>
                              <button class="country-btn" data-country="US">US</button>
                              <button class="country-btn" data-country="IT">IT</button>
                              <button class="country-btn" data-country="UK">UK</button>
                              <button class="country-btn" data-country="JP">JP</button>
                              <button class="country-btn" data-country="AU">AU</button>
                            </div>
                          </div>
                        {% endif %}
                        <div class="thb-filter-content collapsible__content">
                          {%- if filter.param_name == 'filter.v.availability' -%}
                            <div class="thb-filter-availability">
                              {%- assign value = filter.values[0] -%}
                              <input
                                type="checkbox"
                                name="{{ value.param_name }}"
                                value="{{ value.value }}"
                                class="thb-filter-switch custom-checkbox"
                                id="Filter-Mobile-{{ label }}-{{ forloop.index }}"
                                checked
                                {% if value.count == 0 and value.active == false %}
                                  disabled
                                {% endif %}
                              >
                              <label for="Filter-Mobile-{{ label }}-{{ forloop.index }}">{{ value.label }}</label>
                            </div>
                          {%- else -%}
                            <scroll-shadow>
                              {%- liquid
                                assign slug = filter.label | downcase | escape

                                if slug contains 'color' or slug contains 'colour' or slug contains 'couleur' or slug contains 'farbe'
                                  if filter_color_swatches
                                    assign slug = 'color'
                                  else
                                    assign slug = ''
                                  endif
                                endif

                                # Additional swatch variant options set inside theme settings
                                assign color_swatches_variant_option = settings.color_swatches_variant_option | downcase | split: ', '

                                if color_swatches_variant_option contains slug
                                  assign slug = 'color'
                                endif

                                if filter.presentation == 'swatch'
                                  assign slug = 'color'
                                endif
                              -%}
                              <ul class="{{ filter.type | escape }}-{{ slug }}">
                                {%- liquid
                                  assign custom_colors = settings.color_swatches | newline_to_br | split: '<br />'
                                  assign key_array = ''
                                  assign val_array = ''

                                  for color in custom_colors
                                    assign key = color | split: ':' | first | rstrip
                                    assign value = color | split: ':' | last | lstrip
                                    assign key_array = key_array | append: ',' | append: key
                                    assign val_array = val_array | append: ',' | append: value
                                  endfor

                                  assign key_array = key_array | remove_first: ',' | strip_newlines | downcase | split: ','
                                  assign val_array = val_array | remove_first: ',' | split: ','

                                  assign sorted_values = filter.values

                                  # Keep the selected values grouped together when operator is AND
                                  if filter.operator == 'AND'
                                    assign active_filter_values = filter.values | where: 'active', true
                                    assign inactive_filter_values = filter.values | where: 'active', false
                                    assign sorted_values = active_filter_values | concat: inactive_filter_values
                                  endif
                                -%}
                                {%- for value in sorted_values -%}
                                  {%- if value.value contains 'MTH' or value.value == 'OS' -%}
                                    {% continue %}
                                  {%- endif -%}
                                  {% if value.value != 'white' and value.value != 'Blanc de blanc' %}
                                    {% if value.value != 'XS'
                                      and value.value != 'S'
                                      and value.value != 'M'
                                      and value.value != 'L'
                                      and value.value != 'XL'
                                      and value.value != 'XXL'
                                    %}
                                      <li data-val="{{ value.value }}">
                                        <input
                                          type="checkbox"
                                          name="{{ value.param_name }}"
                                          value="{{ value.value }}"
                                          id="Filter-Mobile-{{ label }}-{{ forloop.index }}"
                                          {% if value.active %}
                                            checked
                                          {% endif %}
                                          {% if value.count == 0 and value.active == false %}
                                            disabled
                                          {% endif %}
                                        >
                                        {%- if filter.presentation == 'swatch' -%}
                                          {%- liquid
                                            assign bg_value = empty
                                            assign color_value = value.swatch.color

                                            if value.swatch.image
                                              assign bg_value = value.swatch.image | image_url: width: 40
                                            endif
                                          -%}
                                          <label
                                            for="Filter-Mobile-{{ label }}-{{ forloop.index }}"
                                            class="facet-checkbox facet-checkbox--presentation{% if value.count == 0 and value.active == false %} facet-checkbox--disabled{% endif %}"
                                            style="--bg-color: {{ color_value }}; {%- unless bg_value == empty -%}--option-color-image: url('{{ bg_value }}'){%- endunless -%};"
                                            data-tooltip="{{ value.label | escape }} ({{ value.count }})"
                                          >
                                            {{ value.label | escape }}
                                            {% if show_counts -%}
                                              <sup class="count">{{ value.count }}</sup>
                                            {%- endif -%}
                                          </label>
                                        {%- else -%}
                                          {%- liquid
                                            assign color_value = value.value | downcase | escape

                                            for custom_color in key_array
                                              if custom_color == color_value
                                                assign color_value = val_array[forloop.index0]
                                              endif
                                            endfor

                                            assign bg_value = false
                                            if color_value contains '.'
                                              assign bg_value = color_value | file_url
                                              assign color_value = 'var(--bg-body)'
                                            endif
                                          -%}
                                          <label
                                            for="Filter-Mobile-{{ label }}-{{ forloop.index }}"
                                            class="aa facet-checkbox{% if value.count == 0 and value.active == false %} facet-checkbox--disabled{% endif %}"
                                            style="--bg-color: {{ color_value | downcase | escape }};{%- if bg_value != blank -%} --option-color-image: url('{{ bg_value | escape }}');{%- endif -%}"
                                            data-tooltip="{{ value.label | escape }} ({{ value.count }})"
                                          >
                                            <span class="label-value"> {{ value.label | escape }} </span>
                                            {%- if show_counts -%}
                                              <span class="count">({{ value.count }})</span>
                                            {%- endif %}
                                          </label>
                                        {%- endif -%}
                                      </li>
                                    {%- endif -%}
                                  {%- endif -%}
                                {%- endfor -%}
                              </ul>
                            </scroll-shadow>
                          {%- endif -%}
                        </div>
                      </details>
                    </collapsible-card>
                  {% when 'price_range' %}
                    <collapsible-card data-index="{{ forloop.index }}">
                      <details class="thb-filter js-filter" data-index="{{ forloop.index }}" open>
                        <summary class="thb-filter-title">
                          {% comment %}
                            <span></span>
                          {% endcomment %}
                          {{- filter.label | escape }}
                        </summary>
                        <div class="thb-filter-content collapsible__content">
                          <div class="{{ filter.type | escape }} {{ filter.type | escape }}-{{ filter.label | downcase | escape }}">
                            {%- liquid
                              assign currencies_using_comma_decimals = 'ANG,ARS,BRL,BYN,BYR,CLF,CLP,COP,CRC,CZK,DKK,EUR,HRK,HUF,IDR,ISK,MZN,NOK,PLN,RON,RUB,SEK,TRY,UYU,VES,VND' | split: ','
                              assign uses_comma_decimals = false
                              if currencies_using_comma_decimals contains cart.currency.iso_code
                                assign uses_comma_decimals = true
                              endif

                              assign max_value = null
                              assign min_value = null
                              if uses_comma_decimals
                                if filter.max_value.value
                                  assign max_value = filter.max_value.value | money_without_currency | replace: '.', ''
                                endif
                                if filter.min_value.value
                                  assign min_value = filter.min_value.value | money_without_currency | replace: '.', ''
                                endif
                                assign range_max = filter.range_max | money_without_currency | replace: '.', ''
                              else
                                if filter.max_value.value
                                  assign max_value = filter.max_value.value | money_without_currency | replace: ',', ''
                                endif
                                if filter.min_value.value
                                  assign min_value = filter.min_value.value | money_without_currency | replace: ',', ''
                                endif
                                assign range_max = filter.range_max | money_without_currency | replace: ',', '' | divided_by: 1.00
                              endif
                            %}
                            {%- assign max_price_amount = filter.range_max | money | strip_html | escape -%}
                            <span class="price-highest">
                              {{- 'products.facets.max_price' | t: price: max_price_amount -}}
                            </span>
                            <price-slider class="price_slider_wrapper">
                              <div
                                class="price_slider"
                                data-min-value="{{ min_value }}"
                                data-min-name="filter.v.price.gte"
                                data-min="0"
                                data-max-value="{{ max_value }}"
                                data-max-name="filter.v.price.lte"
                                data-max="{{ range_max }}"
                              ></div>
                              <div class="price_slider_amount">
                                <div>
                                  <span class="field-currency">{{ cart.currency.symbol }}</span>
                                  <input
                                    class="field__input field__input_min"
                                    name="{{ filter.min_value.param_name }}"
                                    id="Filter-{{ filter.label | escape }}-GTE-mobile"
                                    value="{{ min_value }}"
                                    type="text"
                                    placeholder="0"
                                  >
                                </div>
                                <div>
                                  <span class="field-currency">{{ cart.currency.symbol }}</span>
                                  <input
                                    class="field__input field__input_max"
                                    name="{{ filter.max_value.param_name }}"
                                    id="Filter-{{ filter.label | escape }}-LTE-mobile"
                                    value="{{ max_value }}"
                                    type="text"
                                    placeholder="{{ filter.range_max | money_without_currency }}"
                                  >
                                </div>
                              </div>
                            </price-slider>
                          </div>
                        </div>
                      </details>
                    </collapsible-card>
                {% endcase %}
              {%- endfor -%}
              {%- if enable_sorting and false -%}
                <div class="thb-filter-sort-count thb-filter">
                  <div class="thb-filter-sort">
                    <div class="thb-filter-title">{{ 'products.facets.sort_by_label' | t }}</div>
                    <div class="select">
                      {%- assign sort_by = results.sort_by | default: results.default_sort_by -%}
                      <label for="SortByMobile" class="visually-hidden">
                        {{- 'products.facets.sort_by_label' | t -}}
                      </label>
                      <select
                        name="sort_by"
                        class="facet-filters__sort select__select caption-large"
                        id="SortByMobile"
                        aria-describedby="a11y-refresh-page-message"
                      >
                        {%- for option in results.sort_options -%}
                          <option
                            value="{{ option.value | escape }}"
                            {% if option.value == sort_by %}
                              selected="selected"
                            {% endif %}
                          >
                            {{ option.name | escape }}
                          </option>
                        {%- endfor -%}
                      </select>
                      <div class="select-arrow">{%- render 'svg-icons' with 'thb-select' -%}</div>
                    </div>
                  </div>
                </div>
              {%- endif -%}
            </form>
          </facet-filters-form>
        </div>
        <div class="side-panel-footer">
          <div>
            <a class="mobile-filters-clear button outline resetFilters" href="#"
              ><span class="m-none">{{ 'products.facets.clear_all' | t }}</span
              ><span class="d-none">Clear filters</span></a
            >
          </div>
          <button class="button mobile-filters-apply" data-onclick="document.querySelector('.click-capture').click()">
            <span class="m-none">{{ 'products.facets.apply' | t }}</span><span class="d-none">Apply filters</span>
          </button>
        </div>
      </div>
    </div>
  </FacetFiltersFormMobile>
{%- endif -%}