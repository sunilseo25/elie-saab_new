{{ 'featured-collection.css' | asset_url | stylesheet_tag }}
{{ 'product-grid.css' | asset_url | stylesheet_tag }}
{%- liquid
	assign section_heading = section.settings.heading
	assign section_heading_left = section.settings.heading_left
	assign section_description = section.settings.description
	assign full_width = section.settings.full_width
	assign display_type = section.settings.display_type
	assign columns_desktop = section.settings.columns_desktop
	assign product_limit = section.settings.product_limit

	assign show_progress_bar = section.settings.show_progress_bar
	assign disable_top_spacing = section.settings.disable_top_spacing
	assign disable_bottom_spacing = section.settings.disable_bottom_spacing
	assign columns_class = 'small-6 medium-6 large-4'
	case columns_desktop
		when 2
			assign columns_class = 'small-6 medium-6'
		when 3
			assign columns_class = 'small-6 medium-4'
		when 4
			assign columns_class = 'small-6 medium-6 large-3'
		when 5
			assign columns_class = 'small-6 medium-4 large-1/5'
	endcase

	if display_type == 'carousel'
		assign element = 'slide-show'
	else
		assign element = 'div'
	endif

    assign product_id = product.id
    if template == 'cart' and cart != empty
      assign product_id = cart.items[0].product_id
    endif
-%}

<div class="featured-collection row{% if full_width %} full-width-row{% endif %}">
  <div class="small-12 columns">
    <product-recommendations class="product-recommendations" data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product_id }}&limit={{ product_limit }}&intent=related">
      {% if recommendations.performed and recommendations.products_count > 0 %}
        <div class="section-spacing{% if disable_top_spacing %} section-spacing--disable-top{% endif %}{% if disable_bottom_spacing %} section-spacing--disable-bottom{% endif %}">
          {% render 'section-header', section_heading: section_heading, section_description: section_description, section_heading_left: section_heading_left, md_heading_left: section.settings.md_heading_left %}
          <div class="featured-collection__inner display-type--{{ display_type }}">
            <{{ element }} id="product-grid-{{ section.id }}" class="products row {{ display_type }}">
              {% assign shown = 0 %}
              {% assign current_handles = product.collections | map: 'handle' %}
              {% for recommendation in recommendations.products %}
                {%- assign same_collection = true -%}
                  {% assign title_lc = product.title | downcase %}
                {% if title_lc contains 'look' %}
                  {%- assign same_collection = false -%}
                  {%- for c in recommendation.collections -%}
                    {%- if current_handles contains c.handle -%}
                      {%- assign same_collection = true -%}{% break %}
                    {%- endif -%}
                  {%- endfor -%}
                {%- endif -%}
              
                {%- unless same_collection == false or shown >= product_limit -%}
                  <div class="{{ columns_class }} columns {% if display_type == 'carousel' %}carousel__slide{% endif %}">
                    {% render 'product-card', product_card_product: recommendation %}
                  </div>
                  {% assign shown = shown | plus: 1 %}
                {%- endunless -%}
              {% endfor %}
              {%- if display_type == 'carousel' -%}
                {%- if product_limit > columns_desktop -%}
                {%- render 'slideshow-arrows' -%}
                {%- endif -%}
              {%- endif -%}
            </{{ element }}>
            {%- if display_type == 'carousel' and show_progress_bar -%}
            <div class="flickity-progress">
              <div class="flickity-progress--bar"></div>
            </div>
            {%- endif -%}
          </div>
        </div>
      {% endif %}
    </product-recommendations>
  </div>
</div>

{%- unless settings.cart_recommendations -%}
  <script src="{{ 'product-recommendations.js' | asset_url }}" defer="defer"></script>
{%- endunless -%}
{% schema %}

{
  "name": "Product recommendations",
  "class": "section-product-recommendations",
  "settings": [
    {
        "type": "paragraph",
        "content": "Customize product recommendations with Search and Discovery app. [Learn more](https://help.shopify.com/en/manual/online-store/search-and-discovery/product-recommendations)."
    },
    {
        "type": "text",
        "id": "heading",
        "label": "Heading",
        "default": "You may also like"
    },
    {
        "type": "checkbox",
        "id": "heading_left",
        "default": false,
        "label": "Left align heading"
    },
    {
        "type": "checkbox",
        "id": "md_heading_left",
        "default": false,
        "label": "Left align heading on mobile"
    },
    {
        "type": "richtext",
        "id": "description",
        "label": "Description",
        "default": "<p>Describe your featured collection here</p>"
    },
    {
        "type": "checkbox",
        "id": "full_width",
        "label": "Make section full width",
        "default": true
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "select",
      "id": "display_type",
      "options": [
        {
          "value": "grid",
          "label": "Grid"
        },
        {
          "value": "carousel",
          "label": "Carousel"
        }
      ],
      "default": "grid",
      "label": "Display type"
    },
    {
      "type": "range",
      "id": "product_limit",
      "min": 2,
      "max": 12,
      "step": 1,
      "label": "Maximum products to show",
      "default": 4
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 4,
      "label": "Number of columns on desktop"
    },
    {
      "type": "header",
      "content": "Carousel"
    },
    {
      "type": "checkbox",
      "id": "show_progress_bar",
      "label": "Show progress bar",
      "default": true
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "checkbox",
      "id": "disable_top_spacing",
      "default": false,
      "label": "Remove top spacing"
    },
    {
      "type": "checkbox",
      "id": "disable_bottom_spacing",
      "default": false,
      "label": "Remove bottom spacing"
    }
  ],
  "enabled_on": {
    "templates": [
      "*"
    ],
    "groups": [
      "header",
      "footer"
    ]
  }
}
{% endschema %}